<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NDVSU Lab Management System - Complete</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{--deep:#0a0e1a;--surface:#111827;--card:#1a2235;--border:#1e2d45;--accent:#00d4ff;--accent2:#7c3aed;--accent3:#10b981;--accent4:#f59e0b;--accent5:#ef4444;--text:#e2e8f0;--muted:#64748b;--bio-color:#10b981;--hemo-color:#7c3aed;--admin-color:#00d4ff;--recep-color:#f59e0b}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--deep);color:var(--text);min-height:100vh;overflow-x:hidden}
.bg-grid{position:fixed;inset:0;z-index:0;background-image:linear-gradient(rgba(0,212,255,0.03)1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.03)1px,transparent 1px);background-size:40px 40px;pointer-events:none}
.bg-orb{position:fixed;border-radius:50%;filter:blur(120px);pointer-events:none;z-index:0}
.bg-orb-1{width:600px;height:600px;background:rgba(0,212,255,0.07);top:-200px;right:-200px;animation:orbFloat 12s ease-in-out infinite}
.bg-orb-2{width:500px;height:500px;background:rgba(124,58,237,0.07);bottom:-100px;left:-100px;animation:orbFloat 15s ease-in-out infinite reverse}
@keyframes orbFloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-30px) scale(1.05)}}
.page{display:none;position:relative;z-index:1;min-height:100vh}
.page.active{display:flex;flex-direction:column}
#login-screen{align-items:center;justify-content:center;padding:20px;background:var(--deep)}
.login-container{width:100%;max-width:1100px;display:flex;flex-direction:column;align-items:center;gap:48px}
.logo-section{text-align:center}
.logo-icon{width:80px;height:80px;margin:0 auto 16px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:36px;box-shadow:0 0 40px rgba(0,212,255,0.3);animation:pulse-glow 3s ease-in-out infinite}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 40px rgba(0,212,255,0.3)}50%{box-shadow:0 0 60px rgba(0,212,255,0.5)}}
.logo-section h1{font-family:'Syne',sans-serif;font-size:clamp(28px,4vw,42px);font-weight:800;background:linear-gradient(135deg,var(--accent),#fff 60%,var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-1px}
.logo-section p{color:var(--muted);font-family:'DM Mono',monospace;font-size:13px;margin-top:6px;letter-spacing:2px;text-transform:uppercase}
.modal-overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:all 0.3s}
.modal-overlay.show{opacity:1;pointer-events:all}
.modal-box{background:var(--card);border:1px solid var(--border);border-radius:24px;padding:40px;width:100%;max-width:420px;transform:translateY(20px) scale(0.97);transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);position:relative;max-height:90vh;overflow-y:auto}
.modal-overlay.show .modal-box{transform:translateY(0) scale(1)}
.modal-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:4px;transition:color 0.2s}
.modal-close:hover{color:var(--text)}
.modal-title{font-family:'Syne',sans-serif;font-size:24px;font-weight:700;margin-bottom:6px}
.modal-subtitle{color:var(--muted);font-size:14px;margin-bottom:28px}
.form-group{margin-bottom:18px}
.form-label{display:block;font-size:13px;font-weight:500;color:var(--muted);margin-bottom:8px;letter-spacing:0.5px}
.form-input,.form-select{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 16px;color:var(--text);font-size:15px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color 0.2s,box-shadow 0.2s}
.form-input:focus,.form-select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,212,255,0.1)}
.btn-primary{width:100%;padding:14px;border:none;border-radius:10px;font-family:'Syne',sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.btn-primary:hover{filter:brightness(1.1);transform:translateY(-1px)}
.top-nav{background:rgba(17,24,39,0.8);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:50}
.nav-brand{display:flex;align-items:center;gap:12px}
.nav-logo{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
.nav-title{font-family:'Syne',sans-serif;font-weight:700;font-size:16px}
.nav-role{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:1px}
.nav-user{display:flex;align-items:center;gap:12px}
.nav-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;font-family:'Syne',sans-serif}
.logout-btn{background:none;border:1px solid var(--border);color:var(--muted);padding:6px 14px;border-radius:8px;font-size:13px;cursor:pointer;transition:all 0.2s;font-family:'DM Sans',sans-serif}
.logout-btn:hover{border-color:var(--accent5);color:var(--accent5)}
.app-layout{display:flex;height:calc(100vh - 64px)}
.sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}
.sidebar-section{padding:16px 12px}
.sidebar-label{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);padding:8px 12px;font-family:'DM Mono',monospace}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;font-size:14px;color:var(--muted);transition:all 0.2s;margin-bottom:2px}
.nav-item:hover{background:rgba(255,255,255,0.05);color:var(--text)}
.nav-item.active{background:var(--accent);color:#000;font-weight:600}
.nav-item .icon{font-size:18px;width:20px;text-align:center}
.main-content{flex:1;overflow-y:auto;padding:28px}
.content-section{display:none}
.content-section.active{display:block}
.section-header{margin-bottom:28px}
.section-title{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;letter-spacing:-0.5px}
.section-subtitle{color:var(--muted);font-size:14px;margin-top:4px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:28px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;position:relative;overflow:hidden}
.stat-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--stat-color,var(--accent))}
.stat-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-family:'DM Mono',monospace}
.stat-value{font-family:'Syne',sans-serif;font-size:36px;font-weight:800;margin:6px 0;color:var(--stat-color,var(--text))}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:20px}
.card-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:16px}
.btn{border:none;border-radius:10px;padding:10px 16px;font-family:'Syne',sans-serif;font-weight:600;cursor:pointer;transition:all 0.2s;font-size:14px}
.btn-accent{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.btn-accent:hover{filter:brightness(1.1)}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted);padding:6px 12px;font-size:12px}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
.btn-sm{padding:6px 12px;font-size:12px}
#toast{position:fixed;bottom:24px;right:24px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 24px;display:flex;align-items:center;gap:12px;z-index:200;transform:translateY(100px);opacity:0;transition:all 0.3s;pointer-events:none}
#toast.show{transform:translateY(0);opacity:1;pointer-events:all}
#toast-icon{font-size:20px}
#toast-msg{color:var(--text);font-size:14px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border);color:var(--text)}
th{background:var(--surface);font-weight:600;color:var(--accent);font-size:12px;text-transform:uppercase}
tr:hover{background:rgba(0,212,255,0.05)}
.badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase}
.badge-pending{background:rgba(245,158,11,0.2);color:var(--accent4)}
.badge-completed{background:rgba(16,185,129,0.2);color:var(--accent3)}
.badge-verified{background:rgba(0,212,255,0.2);color:var(--accent)}
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="bg-orb bg-orb-1"></div>
<div class="bg-orb bg-orb-2"></div>

<div id="login-screen" class="page active">
  <div class="login-container">
    <div class="logo-section">
      <div class="logo-icon">üêæ</div>
      <h1>NDVSU Lab Management</h1>
      <p>Cloud Edition ‚Ä¢ Multi-Access</p>
    </div>
    <div class="modal-overlay show">
      <div class="modal-box" id="loginModalBox">
        <h2 class="modal-title">Welcome</h2>
        <p class="modal-subtitle">Sign in to your clinic account</p>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="loginEmail" class="form-input" placeholder="your@clinic.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" id="loginPass" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>
        <button class="btn-primary" onclick="doLogin()">Sign In</button>
        <div style="margin-top:20px;text-align:center;color:var(--muted);font-size:13px">
          <button onclick="showSignup()" style="background:none;border:none;color:var(--accent);cursor:pointer;font-weight:600">Create Account</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="main-app" class="page">
  <div class="top-nav">
    <div class="nav-brand">
      <div class="nav-logo" id="navLogo"></div>
      <div>
        <div class="nav-title" id="navTitle"></div>
        <div class="nav-role" id="navRole"></div>
      </div>
    </div>
    <div class="nav-user">
      <div class="nav-avatar" id="navAvatar"></div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>
  <div class="app-layout">
    <div class="sidebar" id="sidebar"></div>
    <div class="main-content" id="mainContent"></div>
  </div>
</div>

<div id="toast">
  <div id="toast-icon"></div>
  <div id="toast-msg"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, setDoc, query, where } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  import { getStorage } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDmwtidfH1WNT2HWuotX6EMS-yMX30mSa4",
    authDomain: "ndvsu-a39b3.firebaseapp.com",
    projectId: "ndvsu-a39b3",
    storageBucket: "ndvsu-a39b3.firebasestorage.app",
    messagingSenderId: "181495983520",
    appId: "1:181495983520:web:d88a37f5637ad2b33fc8c5",
    measurementId: "G-NVN9DZ52PY"
  };

  const firebaseApp = initializeApp(firebaseConfig);
  const auth = getAuth(firebaseApp);
  const db = getFirestore(firebaseApp);
  const storage = getStorage(firebaseApp);

  window.auth = auth;
  window.db = db;
  window.storage = storage;
  window.getAuth = getAuth;
  window.signInWithEmailAndPassword = signInWithEmailAndPassword;
  window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
  window.signOut = signOut;
  window.collection = collection;
  window.addDoc = addDoc;
  window.getDocs = getDocs;
  window.deleteDoc = deleteDoc;
  window.doc = doc;
  window.getDoc = getDoc;
  window.setDoc = setDoc;
  window.query = query;
  window.where = where;

  window.firebaseInitCallback?.();
</script>

<script>
const App = { role: null, user: null, email: null, clinicId: 'NDVSU-001' };
const ROLES = {
  admin: { icon: '‚öôÔ∏è', name: 'Administrator', color: '#00d4ff' },
  receptionist: { icon: 'üë§', name: 'Receptionist', color: '#f59e0b' },
  biochemist: { icon: 'üß™', name: 'Biochemist', color: '#10b981' },
  hematologist: { icon: 'üî¨', name: 'Hematologist', color: '#7c3aed' }
};

let patients = [];
let testResults = [];
let criteria = [];

// LOGIN
function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPass').value;
  if(!email || !password) { showToast('‚ö†Ô∏è', 'Enter email and password'); return; }
  
  signInWithEmailAndPassword(window.auth, email, password)
    .then(userCred => {
      App.email = email;
      App.user = userCred.user.uid;
      loadUserRole();
    })
    .catch(err => showToast('‚ùå', 'Invalid credentials'));
}

function showSignup() {
  const email = prompt('Email:');
  if(!email) return;
  const password = prompt('Password (min 6):');
  if(!password || password.length < 6) { showToast('‚ö†Ô∏è', 'Min 6 chars'); return; }
  const role = confirm('Admin? (OK=Admin, Cancel=Receptionist)') ? 'admin' : 'receptionist';
  
  createUserWithEmailAndPassword(window.auth, email, password)
    .then(userCred => {
      setDoc(window.doc(window.db, 'users', userCred.user.uid), { email, role, clinicId: 'NDVSU-001', createdAt: new Date() });
      showToast('‚úÖ', 'Account created! Log in now');
    })
    .catch(err => showToast('‚ùå', err.message));
}

function loadUserRole() {
  getDoc(window.doc(window.db, 'users', App.user))
    .then(docSnap => {
      if(docSnap.exists()) {
        App.role = docSnap.data().role;
        loadAppData();
        initializeApp();
      } else {
        showToast('‚ùå', 'User profile not found');
      }
    })
    .catch(err => showToast('‚ùå', 'Error loading user'));
}

function loadAppData() {
  getDocs(window.collection(window.db, 'clinics', App.clinicId, 'patients'))
    .then(snap => { patients = []; snap.forEach(doc => patients.push({id: doc.id, ...doc.data()})); })
    .catch(err => console.error(err));
  
  getDocs(window.collection(window.db, 'clinics', App.clinicId, 'testResults'))
    .then(snap => { testResults = []; snap.forEach(doc => testResults.push({id: doc.id, ...doc.data()})); })
    .catch(err => console.error(err));

  getDocs(window.collection(window.db, 'clinics', App.clinicId, 'criteria'))
    .then(snap => { criteria = []; snap.forEach(doc => criteria.push({id: doc.id, ...doc.data()})); })
    .catch(err => console.error(err));
}

function initializeApp() {
  document.getElementById('login-screen').classList.remove('active');
  document.getElementById('main-app').classList.add('active');
  renderNav();
  renderSidebar();
  showSection('dashboard');
}

function renderNav() {
  const role = ROLES[App.role];
  document.getElementById('navLogo').innerHTML = role.icon;
  document.getElementById('navTitle').textContent = 'NDVSU Lab';
  document.getElementById('navRole').textContent = role.name;
  document.getElementById('navAvatar').textContent = App.email.charAt(0).toUpperCase();
  document.getElementById('navAvatar').style.background = role.color;
}

function renderSidebar() {
  let html = '<div class="sidebar-section"><div class="sidebar-label">Main</div>';
  
  const menuItems = {
    admin: [
      {id: 'dashboard', icon: 'üìä', label: 'Dashboard'},
      {id: 'patients', icon: 'üêæ', label: 'Patients'},
      {id: 'results', icon: 'üìã', label: 'Test Results'},
      {id: 'reports', icon: 'üìÑ', label: 'Reports'},
      {id: 'criteria', icon: 'üéØ', label: 'Criteria'},
      {id: 'settings', icon: '‚öôÔ∏è', label: 'Settings'}
    ],
    receptionist: [
      {id: 'dashboard', icon: 'üìä', label: 'Dashboard'},
      {id: 'patients', icon: 'üêæ', label: 'Patients'},
      {id: 'reports', icon: 'üìÑ', label: 'Reports'}
    ],
    biochemist: [
      {id: 'dashboard', icon: 'üìä', label: 'Dashboard'},
      {id: 'results', icon: 'üìã', label: 'Test Results'},
      {id: 'reports', icon: 'üìÑ', label: 'Reports'}
    ],
    hematologist: [
      {id: 'dashboard', icon: 'üìä', label: 'Dashboard'},
      {id: 'results', icon: 'üìã', label: 'Test Results'},
      {id: 'reports', icon: 'üìÑ', label: 'Reports'}
    ]
  };

  (menuItems[App.role] || []).forEach(item => {
    html += `<div class="nav-item" onclick="showSection('${item.id}')"><span class="icon">${item.icon}</span><span>${item.label}</span></div>`;
  });
  html += '</div>';
  document.getElementById('sidebar').innerHTML = html;
}

function showSection(sectionId) {
  let html = '';
  
  if(sectionId === 'dashboard') {
    html = `<div class="content-section active">
      <div class="section-header"><h1 class="section-title">Dashboard</h1><p class="section-subtitle">Lab overview & quick stats</p></div>
      <div class="stats-grid">
        <div class="stat-card" style="--stat-color:var(--accent)"><div class="stat-label">Patients</div><div class="stat-value">${patients.length}</div></div>
        <div class="stat-card" style="--stat-color:var(--bio-color)"><div class="stat-label">Tests Pending</div><div class="stat-value">${testResults.filter(r => r.status === 'pending').length}</div></div>
        <div class="stat-card" style="--stat-color:var(--accent3)"><div class="stat-label">Tests Completed</div><div class="stat-value">${testResults.filter(r => r.status === 'completed').length}</div></div>
        <div class="stat-card" style="--stat-color:var(--hemo-color)"><div class="stat-label">Criteria</div><div class="stat-value">${criteria.length}</div></div>
      </div>
    </div>`;
  } 
  else if(sectionId === 'patients') {
    html = renderPatientsSection();
  }
  else if(sectionId === 'results') {
    html = renderResultsSection();
  }
  else if(sectionId === 'reports') {
    html = renderReportsSection();
  }
  else if(sectionId === 'criteria') {
    html = renderCriteriaSection();
  }
  else if(sectionId === 'settings') {
    html = renderSettings();
  }

  document.getElementById('mainContent').innerHTML = html;
}

// PATIENTS
function renderPatientsSection() {
  let html = `<div class="content-section active">
    <div class="section-header"><h1 class="section-title">Patients</h1><p class="section-subtitle">Manage patient records</p></div>
    ${App.role === 'receptionist' || App.role === 'admin' ? `
    <div class="card">
      <div class="card-title">Add New Patient</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="form-group"><label class="form-label">Patient Name</label><input type="text" id="patientName" class="form-input" placeholder="Pet name"></div>
        <div class="form-group"><label class="form-label">Species</label><select id="patientSpecies" class="form-select"><option>Canine</option><option>Feline</option><option>Avian</option><option>Reptile</option><option>Equine</option></select></div>
        <div class="form-group"><label class="form-label">Owner Name</label><input type="text" id="patientOwner" class="form-input" placeholder="Owner name"></div>
        <div class="form-group"><label class="form-label">Contact</label><input type="tel" id="patientContact" class="form-input" placeholder="Phone"></div>
      </div>
      <button class="btn btn-accent" onclick="addPatient()">Add Patient</button>
    </div>
    ` : ''}
    <div class="card">
      <div class="card-title">Patient Records (${patients.length})</div>
      <div id="patientsList"></div>
    </div>
  </div>`;
  
  setTimeout(() => renderPatientsList(), 100);
  return html;
}

function addPatient() {
  const name = document.getElementById('patientName').value.trim();
  const species = document.getElementById('patientSpecies').value;
  const owner = document.getElementById('patientOwner').value.trim();
  const contact = document.getElementById('patientContact').value.trim();
  
  if(!name || !owner) { showToast('‚ö†Ô∏è', 'Enter patient and owner'); return; }
  
  window.addDoc(window.collection(window.db, 'clinics', App.clinicId, 'patients'), {
    name, species, owner, contact, createdAt: new Date(), createdBy: App.user
  })
    .then(docRef => {
      patients.push({id: docRef.id, name, species, owner, contact, createdAt: new Date()});
      document.getElementById('patientName').value = '';
      document.getElementById('patientOwner').value = '';
      document.getElementById('patientContact').value = '';
      showToast('‚úÖ', 'Patient added');
      renderPatientsList();
    })
    .catch(err => showToast('‚ùå', 'Error adding patient'));
}

function renderPatientsList() {
  const list = document.getElementById('patientsList');
  if(!list) return;
  
  if(patients.length === 0) {
    list.innerHTML = '<div style="color:var(--muted);padding:20px 0">No patients yet</div>';
    return;
  }

  let html = '<table><thead><tr><th>Patient</th><th>Species</th><th>Owner</th><th>Contact</th><th>Actions</th></tr></thead><tbody>';
  patients.forEach(p => {
    html += `<tr><td>${p.name}</td><td>${p.species}</td><td>${p.owner}</td><td>${p.contact}</td><td>
      <button class="btn btn-sm btn-ghost" onclick="viewPatient('${p.id}')">View</button>
      ${(App.role === 'admin' || App.role === 'receptionist') ? `<button class="btn btn-sm btn-ghost" onclick="deletePatient('${p.id}')">Delete</button>` : ''}
    </td></tr>`;
  });
  html += '</tbody></table>';
  list.innerHTML = html;
}

function viewPatient(patientId) {
  const patient = patients.find(p => p.id === patientId);
  if(patient) showToast('‚ÑπÔ∏è', `Patient: ${patient.name}`);
}

function deletePatient(patientId) {
  if(confirm('Delete this patient?')) {
    window.deleteDoc(window.doc(window.db, 'clinics', App.clinicId, 'patients', patientId))
      .then(() => {
        patients = patients.filter(p => p.id !== patientId);
        showToast('‚úÖ', 'Patient deleted');
        renderPatientsList();
      })
      .catch(err => showToast('‚ùå', 'Error deleting'));
  }
}

// TEST RESULTS
function renderResultsSection() {
  let html = `<div class="content-section active">
    <div class="section-header"><h1 class="section-title">Test Results</h1><p class="section-subtitle">Manage lab test results</p></div>
    ${(App.role === 'biochemist' || App.role === 'hematologist' || App.role === 'admin') ? `
    <div class="card">
      <div class="card-title">Add Test Result</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="form-group"><label class="form-label">Patient</label><select id="resultPatient" class="form-select">${patients.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select></div>
        <div class="form-group"><label class="form-label">Test Type</label><input type="text" id="resultTest" class="form-input" placeholder="e.g., Blood Test"></div>
        <div class="form-group"><label class="form-label">Result Value</label><input type="text" id="resultValue" class="form-input" placeholder="e.g., 7.5"></div>
        <div class="form-group"><label class="form-label">Reference Range</label><input type="text" id="resultRef" class="form-input" placeholder="e.g., 5-10"></div>
      </div>
      <button class="btn btn-accent" onclick="addTestResult()">Add Result</button>
    </div>
    ` : ''}
    <div class="card">
      <div class="card-title">Test Results (${testResults.length})</div>
      <div id="resultsList"></div>
    </div>
  </div>`;
  
  setTimeout(() => renderResultsList(), 100);
  return html;
}

function addTestResult() {
  const patientId = document.getElementById('resultPatient').value;
  const testType = document.getElementById('resultTest').value.trim();
  const resultValue = document.getElementById('resultValue').value.trim();
  const refRange = document.getElementById('resultRef').value.trim();
  
  if(!patientId || !testType || !resultValue) { showToast('‚ö†Ô∏è', 'Fill all fields'); return; }
  
  window.addDoc(window.collection(window.db, 'clinics', App.clinicId, 'testResults'), {
    patientId, testType, resultValue, refRange, status: 'pending', createdAt: new Date(), createdBy: App.user
  })
    .then(docRef => {
      testResults.push({id: docRef.id, patientId, testType, resultValue, refRange, status: 'pending'});
      document.getElementById('resultTest').value = '';
      document.getElementById('resultValue').value = '';
      document.getElementById('resultRef').value = '';
      showToast('‚úÖ', 'Test result added');
      renderResultsList();
    })
    .catch(err => showToast('‚ùå', 'Error adding result'));
}

function renderResultsList() {
  const list = document.getElementById('resultsList');
  if(!list) return;
  
  if(testResults.length === 0) {
    list.innerHTML = '<div style="color:var(--muted);padding:20px 0">No test results yet</div>';
    return;
  }

  let html = '<table><thead><tr><th>Patient</th><th>Test</th><th>Value</th><th>Reference</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
  testResults.forEach(r => {
    const patient = patients.find(p => p.id === r.patientId);
    const statusColor = r.status === 'pending' ? 'badge-pending' : r.status === 'completed' ? 'badge-completed' : 'badge-verified';
    html += `<tr><td>${patient?.name || 'Unknown'}</td><td>${r.testType}</td><td>${r.resultValue}</td><td>${r.refRange}</td><td><span class="badge ${statusColor}">${r.status}</span></td><td>
      ${(App.role === 'biochemist' || App.role === 'hematologist' || App.role === 'admin') && r.status === 'pending' ? `<button class="btn btn-sm btn-ghost" onclick="completeTest('${r.id}')">Complete</button>` : ''}
      ${(App.role === 'admin') ? `<button class="btn btn-sm btn-ghost" onclick="deleteResult('${r.id}')">Delete</button>` : ''}
    </td></tr>`;
  });
  html += '</tbody></table>';
  list.innerHTML = html;
}

function completeTest(resultId) {
  const result = testResults.find(r => r.id === resultId);
  if(result) {
    window.setDoc(window.doc(window.db, 'clinics', App.clinicId, 'testResults', resultId), {...result, status: 'completed'});
    testResults = testResults.map(r => r.id === resultId ? {...r, status: 'completed'} : r);
    showToast('‚úÖ', 'Test marked completed');
    renderResultsList();
  }
}

function deleteResult(resultId) {
  if(confirm('Delete this result?')) {
    window.deleteDoc(window.doc(window.db, 'clinics', App.clinicId, 'testResults', resultId))
      .then(() => {
        testResults = testResults.filter(r => r.id !== resultId);
        showToast('‚úÖ', 'Result deleted');
        renderResultsList();
      });
  }
}

// REPORTS
function renderReportsSection() {
  let html = `<div class="content-section active">
    <div class="section-header"><h1 class="section-title">Reports</h1><p class="section-subtitle">View and generate reports</p></div>
    <div class="card">
      <div class="card-title">Patient Reports</div>
      <div id="reportsList"></div>
    </div>
  </div>`;
  
  setTimeout(() => renderReportsList(), 100);
  return html;
}

function renderReportsList() {
  const list = document.getElementById('reportsList');
  if(!list) return;
  
  if(patients.length === 0) {
    list.innerHTML = '<div style="color:var(--muted)">No patients to report</div>';
    return;
  }

  let html = '<table><thead><tr><th>Patient</th><th>Species</th><th>Tests</th><th>Actions</th></tr></thead><tbody>';
  patients.forEach(p => {
    const patientTests = testResults.filter(t => t.patientId === p.id);
    html += `<tr><td><strong>${p.name}</strong></td><td>${p.species}</td><td>${patientTests.length} test(s)</td><td>
      <button class="btn btn-sm btn-ghost" onclick="generateReport('${p.id}')">Generate</button>
    </td></tr>`;
  });
  html += '</tbody></table>';
  list.innerHTML = html;
}

function generateReport(patientId) {
  const patient = patients.find(p => p.id === patientId);
  const patientTests = testResults.filter(t => t.patientId === patientId);
  
  let report = `PATIENT REPORT\n`;
  report += `Patient: ${patient.name}\n`;
  report += `Species: ${patient.species}\n`;
  report += `Owner: ${patient.owner}\n`;
  report += `Contact: ${patient.contact}\n`;
  report += `Generated: ${new Date().toLocaleDateString()}\n\n`;
  report += `TEST RESULTS:\n`;
  patientTests.forEach(t => {
    report += `- ${t.testType}: ${t.resultValue} (Ref: ${t.refRange}) [${t.status}]\n`;
  });
  
  showToast('üìÑ', 'Report: ' + patient.name);
}

// CRITERIA
function renderCriteriaSection() {
  let html = `<div class="content-section active">
    <div class="section-header"><h1 class="section-title">Test Criteria</h1><p class="section-subtitle">Manage diagnostic criteria</p></div>
    ${App.role === 'admin' ? `
    <div class="card">
      <div class="card-title">Add Criteria</div>
      <div class="form-group"><label class="form-label">Criteria Name</label><input type="text" id="criteriaName" class="form-input" placeholder="e.g., Anemia Test"></div>
      <div class="form-group"><label class="form-label">Test Type</label><input type="text" id="criteriaTest" class="form-input" placeholder="e.g., Blood Test"></div>
      <div class="form-group"><label class="form-label">Range</label><input type="text" id="criteriaRange" class="form-input" placeholder="e.g., 5-10"></div>
      <button class="btn btn-accent" onclick="addCriteria()">Add Criteria</button>
    </div>
    ` : ''}
    <div class="card">
      <div class="card-title">Criteria (${criteria.length})</div>
      <div id="criteriaList"></div>
    </div>
  </div>`;
  
  setTimeout(() => renderCriteriaList(), 100);
  return html;
}

function addCriteria() {
  const name = document.getElementById('criteriaName').value.trim();
  const testType = document.getElementById('criteriaTest').value.trim();
  const range = document.getElementById('criteriaRange').value.trim();
  
  if(!name || !testType) { showToast('‚ö†Ô∏è', 'Fill all fields'); return; }
  
  window.addDoc(window.collection(window.db, 'clinics', App.clinicId, 'criteria'), {
    name, testType, range, createdAt: new Date()
  })
    .then(docRef => {
      criteria.push({id: docRef.id, name, testType, range});
      document.getElementById('criteriaName').value = '';
      document.getElementById('criteriaTest').value = '';
      document.getElementById('criteriaRange').value = '';
      showToast('‚úÖ', 'Criteria added');
      renderCriteriaList();
    })
    .catch(err => showToast('‚ùå', 'Error adding criteria'));
}

function renderCriteriaList() {
  const list = document.getElementById('criteriaList');
  if(!list) return;
  
  if(criteria.length === 0) {
    list.innerHTML = '<div style="color:var(--muted)">No criteria yet</div>';
    return;
  }

  let html = '<table><thead><tr><th>Name</th><th>Test Type</th><th>Range</th>${App.role === 'admin' ? '<th>Action</th>' : ''}</tr></thead><tbody>';
  criteria.forEach(c => {
    html += `<tr><td>${c.name}</td><td>${c.testType}</td><td>${c.range}</td>${App.role === 'admin' ? `<td><button class="btn btn-sm btn-ghost" onclick="deleteCriteria('${c.id}')">Delete</button></td>` : ''}</tr>`;
  });
  html += '</tbody></table>';
  list.innerHTML = html;
}

function deleteCriteria(criteriaId) {
  if(confirm('Delete this criteria?')) {
    window.deleteDoc(window.doc(window.db, 'clinics', App.clinicId, 'criteria', criteriaId))
      .then(() => {
        criteria = criteria.filter(c => c.id !== criteriaId);
        showToast('‚úÖ', 'Criteria deleted');
        renderCriteriaList();
      });
  }
}

// SETTINGS
function renderSettings() {
  return `<div class="content-section active">
    <div class="section-header"><h1 class="section-title">Settings</h1></div>
    <div class="card"><div class="card-title">Clinic Info</div>
      <div class="form-group"><label class="form-label">Lab Name</label><input type="text" class="form-input" value="NDVSU Laboratory"></div>
      <div class="form-group"><label class="form-label">Address</label><textarea class="form-input" rows="2">NDVSU Campus, Jabalpur</textarea></div>
      <button class="btn btn-accent" onclick="showToast('‚úÖ','Settings saved')">Save</button>
    </div>
  </div>`;
}

// UTILITIES
function logout() {
  signOut(window.auth);
  location.reload();
}

function showToast(icon, msg) {
  const t = document.getElementById('toast');
  document.getElementById('toast-icon').textContent = icon;
  document.getElementById('toast-msg').textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loginPass').addEventListener('keydown', e => {
    if(e.key === 'Enter') doLogin();
  });
});
</script>
</body>
</html>
